<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Phase 1 - Callee</title>
  <style>
	body { font-family: system-ui, sans-serif; margin: 20px; }
	video { width: 320px; height: 240px; background: #000; margin-right: 10px; }
	.row { margin-bottom: 10px; }
	input { padding: 4px 8px; }
	button { padding: 6px 10px; margin-right: 4px; }
	#log { white-space: pre-wrap; background: #f5f5f5; padding: 8px; border-radius: 4px; max-height: 200px; overflow-y: auto; }
  </style>
</head>
<body>
  <h1>Phase 1 - Callee</h1>

  <div class="row">
	<label>Room ID: <input id="roomId" value="room1" /></label>
	<button id="connectBtn">Connect</button>
  </div>

  <div class="row">
	<video id="localVideo" autoplay playsinline muted></video>
	<video id="remoteVideo" autoplay playsinline></video>
  </div>

  <h3>Log</h3>
  <div id="log"></div>

  <script>
	const roomInput = document.getElementById('roomId');
	const connectBtn = document.getElementById('connectBtn');
	const localVideo = document.getElementById('localVideo');
	const remoteVideo = document.getElementById('remoteVideo');
	const logEl = document.getElementById('log');

	let ws;
	let pc;
	let localStream;
	let roomId;

	function log(msg) {
		console.log(msg);
		logEl.textContent += `\n${msg}`;
	}

	function connect() {
		roomId = roomInput.value.trim();
		if (!roomId) {
			alert('Enter a room ID');
			return;
		}

		ws = new WebSocket(`ws://${location.host}`);

		ws.onopen = async () => {
			log(`WebSocket connected. Joining room ${roomId}`);
			ws.send(JSON.stringify({ type: 'join', roomId }));
			await setupMediaAndPeer();
		};

		ws.onmessage = async (event) => {
			const msg = JSON.parse(event.data);
			if (!pc) return;

			if (msg.type === 'offer') {
				log('Received offer');
				await pc.setRemoteDescription(new RTCSessionDescription(msg.offer));
				const answer = await pc.createAnswer();
				await pc.setLocalDescription(answer);
				log('Sending answer');
				ws.send(JSON.stringify({ type: 'answer', roomId, answer }));
			} else if (msg.type === 'ice-candidate') {
				log('Received remote ICE candidate');
				try {
					await pc.addIceCandidate(msg.candidate);
				} catch (e) {
					log('Error adding ICE candidate: ' + e);
				}
			}
		};

		ws.onclose = () => log('WebSocket closed');
		ws.onerror = () => log('WebSocket error');
	}

	async function setupMediaAndPeer() {
		localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
		localVideo.srcObject = localStream;

		pc = createPeerConnection();
		localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
	}

	function createPeerConnection() {
		const config = {
			iceServers: [
				{ urls: 'stun:stun.l.google.com:19302' }
			]
		};

		const peer = new RTCPeerConnection(config);

		peer.onicecandidate = (event) => {
			if (event.candidate) {
				log('New ICE candidate: ' + event.candidate.candidate);
				ws.send(JSON.stringify({
					type: 'ice-candidate',
					roomId,
					candidate: event.candidate
				}));
			}
		};

		peer.oniceconnectionstatechange = () => {
			log('ICE state: ' + peer.iceConnectionState);
		};

		peer.ontrack = (event) => {
			log('Received remote track');
			remoteVideo.srcObject = event.streams[0];
		};

		return peer;
	}

	connectBtn.onclick = connect;
  </script>
</body>
</html>
